{% extends 'base.html' %}
{% block content %}
<h2>{{ project.name }}</h2>
<p>{{ project.description }}</p>
<p>Дата начала: {{ project.start_date }}</p>
<p>Дата окончания: {{ project.end_date }}</p>
<p>Статус: {{ project.get_status_display }}</p>

{% if user.groups.all.0.name == "Менеджеры" %}
    <a href="{% url 'create_task' project.id %}" class="btn btn-success">Добавить задачу</a>
{% endif %}

<div class="task-container">
    <div class="task-list">
        <h3>Задачи в процессе</h3>
        <ul>
            {% for task in tasks %}
                {% if task.status == "in_progress" %}
                    <li>
                        <a href="{% url 'task_detail' task.id %}">{{ task.title }}</a>
                        <form action="{% url 'complete_task' task.id %}" method="post" style="display:inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-success">Завершить</button>
                        </form>
                    </li>
                {% endif %}
            {% empty %}
                <p>Нет задач в процессе.</p>
            {% endfor %}
        </ul>
        
        <h3>Завершенные задачи</h3>
        <ul>
            {% for task in tasks %}
                {% if task.status == "done" %}
                    <li>
                        <a href="{% url 'task_detail' task.id %}">{{ task.title }}</a>
                    </li>
                {% endif %}
            {% empty %}
                <p>Нет завершенных задач.</p>
            {% endfor %}
        </ul>
        
        <h3>Ожидающие выполнения</h3>
        <ul>
            {% for task in tasks %}
                {% if task.status == "new" %}
                    <li>
                        <a href="{% url 'task_detail' task.id %}">{{ task.title }}</a>
                        <form action="{% url 'start_task' task.id %}" method="post" style="display:inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-warning">Начать выполнение</button>
                        </form>
                    </li>
                {% endif %}
            {% empty %}
                <p>Нет ожидающих выполнения задач.</p>
            {% endfor %}
        </ul>
        
    </div>
<!-- Подключаем Frappe Gantt -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt/dist/frappe-gantt.css">
<script src="https://cdn.jsdelivr.net/npm/frappe-gantt/dist/frappe-gantt.min.js"></script>

    <div id="gantt-container">
        <h3>Диаграмма Ганта</h3>
        <script>
            console.log("Проверяем функцию: ", typeof renderGanttChart);
            console.log("Frappe Gantt:", typeof Gantt);
            document.addEventListener("DOMContentLoaded", function () {
                console.log("Страница загружена, вызываем рендер диаграммы.");
                renderGanttChart(tasksData);
            });
        </script>
        
        
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const ctx = document.getElementById("ganttChart").getContext("2d");

        const tasks = JSON.parse(`[ 
            {% for task in project.tasks.all %} 
                { 
                    "label": "{{ task.title|escapejs }}", 
                    "start": "{{ task.start_date|date:'Y-m-d' }}", 
                    "end": "{{ task.deadline|date:'Y-m-d' }}" 
                }{% if not forloop.last %},{% endif %} 
            {% endfor %} 
        ]`);



        tasks.forEach(task => {
            task.start = new Date(task.start);
            task.end = new Date(task.end);
        });



        const labels = tasks.map(task => task.label);
        const startDates = tasks.map(task => task.start.getTime());
        const endDates = tasks.map(task => task.end.getTime());

        new Chart(ctx, {
            type: "bar",
            data: {
                labels: labels,
                datasets: [{
                    label: "Сроки выполнения",
                    backgroundColor: "rgba(54, 162, 235, 0.5)",
                    data: startDates.map((start, i) => ({
                        x: labels[i],
                        y: [start, endDates[i]]
                    }))
                }]
            },
            options: {
                scales: {
                    x: { type: "category" },
                    y: { type: "time", time: { unit: "day" } }
                }
            }
        });
    });
</script>


{% endblock %}
